= Clara Rules
:url-docs: http://www.clara-rules.org
:url-first-steps: http://www.clara-rules.org/docs/firststeps/
:url-repo: https://github.com/mlotysz/clara-rules
:url-upstream: https://github.com/oracle-samples/clara-rules

image:{url-repo}/actions/workflows/clojure.yml/badge.svg[Build Status, link={url-repo}/actions/workflows/clojure.yml]

A forward-chaining rules engine for Clojure(Script).

This is a fork of {url-upstream}[oracle-samples/clara-rules].
See {url-docs}[clara-rules.org] for documentation.

== Why This Fork

The upstream repository has been dormant since 2022 (last release 0.24.0).
This fork modernizes the build system and applies substantial performance optimizations to the Rete engine.

=== Build system

* Migrated from Leiningen to Clojure CLI (deps.edn + tools.build)
* Targets Java 21+, upgraded to Clojure 1.12.4 / ClojureScript 1.12.101 / Prismatic Schema 1.4.1
* CLJS tests compile to Node.js target — no browser or Puppeteer required
* Reduced clj-kondo lint warnings from 991 → 6 (5 intentional) across all source files

=== Performance optimizations

Major algorithmic improvements across the alpha and beta networks:

[cols="2,1"]
|===
|Optimization |Status

|`DiscriminationNode` — hash-based alpha dispatch on equality constraints
|Done

|`FusedAlphaNode` — batched alpha dispatch for multi-node fact types
|Done

|Join node unlinking — skip cross-product when opposing side is empty
|Done

|Beta sub-indexing for `ExpressionJoinNode` — O(T×E) → O(T+E)
|Done

|Beta sub-indexing for `NegationWithJoinFilterNode` — O(T×E) → O(T+E)
|Done

|Demand-pull token generation (PHREAK-inspired) — defer `RootJoinNode` token creation
|Done

|Allocation reduction — volatiles, defrecord, MapEntry, eager seqs, mutable caches
|Done
|===

=== Benchmark results (N=100,000 facts, vs oracle 0.24.0)

Selected scenarios from the included benchmark suite (`bench/`):

[cols="3,1,1,1"]
|===
|Scenario |Oracle (ms) |Fork (ms) |Speedup

|Hash join 1:1 — 50k×50k all match
|171,083
|176
|**~975×**

|Hash join sparse — 10% match rate
|96,093
|126
|**~762×**

|Two parallel hash joins
|156,814
|253
|**~619×**

|Three-way hash join
|91,656
|206
|**~446×**

|Truth maintenance convergence
|41,341
|211
|**~196×**

|Negation + alpha filter
|19,891
|158
|**~126×**

|Join + negation
|69,513
|641
|**~108×**

|Double negation
|125,910
|3,374
|**~37×**

|Hash join 1:many (1k×~99)
|5,764
|238
|**~24×**

|20 alpha nodes — even distribution
|257
|102
|**~2.5×**
|===

The extreme join speedups (hundreds to near-thousands×) reflect the oracle's O(N²) behaviour for large cross-products, eliminated here by beta sub-indexing and join unlinking.
Negation speedups are driven by `NegationWithJoinFilterNode` sub-indexing.
Simpler scenarios (pure alpha, rule chains) show modest 1.25–1.4× improvements from allocation reduction.

== Usage

Here's a simple example. Complete documentation is at {url-first-steps}[clara-rules.org].

[source,clojure]
----
(ns clara.support-example
  (:require [clara.rules :refer :all]))

(defrecord SupportRequest [client level])

(defrecord ClientRepresentative [name client])

(defrule is-important
  "Find important support requests."
  [SupportRequest (= :high level)]
  =>
  (println "High support requested!"))

(defrule notify-client-rep
  "Find the client representative and send a notification of a support request."
  [SupportRequest (= ?client client)]
  [ClientRepresentative (= ?client client) (= ?name name)] ; Join via the ?client binding.
  =>
  (println "Notify" ?name "that"  ?client "has a new support request!"))

;; Run the rules! We can just use Clojure's threading macro to wire things up.
(-> (mk-session)
    (insert (->ClientRepresentative "Alice" "Acme")
            (->SupportRequest "Acme" :high))
    (fire-rules))

;;;; Prints this:

;; High support requested!
;; Notify Alice that Acme has a new support request!
----

== Building

Requires Java 21+ and Node.js (for ClojureScript tests).

[source,bash]
----
clojure -T:build javac      # Compile Java sources (required before tests)
clojure -M:test              # Run tests
clojure -M:test-generative   # Run generative tests
clojure -M:test-performance  # Run performance tests
clojure -T:build jar         # Build JAR
----

ClojureScript tests compile to a Node.js target:

[source,bash]
----
clojure -M:cljs-test -m cljs-build simple   # Compile CLJS tests
node target/js/test-simple.js               # Run CLJS tests
----

== Community

Questions about Clara Rules can be posted to the https://groups.google.com/forum/?hl=en#!forum/clara-rules[Google Group] or the https://clojurians.slack.com/messages/clara/[#clara Slack channel] on Clojurians.

== License

Copyright (C) 2018, 2025 Oracle and/or its affiliates.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
